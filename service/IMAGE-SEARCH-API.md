# 图片相似搜索API文档

## 概述

本文档介绍了图片相似搜索的新功能：支持通过**图片ID**或**图片URL**搜索相似图片。

## API接口

### 1. 通过图片ID或URL搜索相似图片

**接口地址：** `GET /api/image-feature/search-by-id-or-url`

**功能描述：** 根据图片ID或URL，搜索数据库中的相似图片

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| imageId | string | 二选一 | 图片ID（需要在数据库中已存在特征向量） |
| imageUrl | string | 二选一 | 图片URL（系统会从URL加载图片并计算特征向量） |
| threshold | number | 否 | 相似度阈值（0-1之间），默认0.8 |

**注意：** `imageId` 和 `imageUrl` 必须提供其中一个，不能同时为空。

**请求示例：**

```bash
# 通过图片ID搜索
curl "http://127.0.0.1:7001/api/image-feature/search-by-id-or-url?imageId=1730869206754000000&threshold=0.8"

# 通过图片URL搜索
curl "http://127.0.0.1:7001/api/image-feature/search-by-id-or-url?imageUrl=https://assets.ecaisys.com/similarity/image.jpg&threshold=0.85"
```

**响应格式：**

```json
{
  "success": true,
  "message": "找到 5 张相似图片（相似度 >= 80%）",
  "data": {
    "query": {
      "type": "imageId",
      "value": "1730869206754000000"
    },
    "count": 5,
    "threshold": 0.8,
    "images": [
      {
        "imageId": "1730869206754000001",
        "url": "https://assets.ecaisys.com/similarity/similar1.jpg",
        "similarity": 95.67,
        "md5": "abc123...",
        "fileType": 2
      },
      {
        "imageId": "1730869206754000002",
        "url": "https://assets.ecaisys.com/similarity/similar2.jpg",
        "similarity": 88.42,
        "md5": "def456...",
        "fileType": 2
      }
    ]
  }
}
```

**错误响应：**

```json
{
  "success": false,
  "message": "请提供 imageId 或 imageUrl 参数"
}
```

```json
{
  "success": false,
  "message": "图片 ID 1234567890 的特征向量不存在，请先处理该图片"
}
```

## 使用场景

### 场景1：已知图片ID，查找相似图片

适用于：
- 已有图片在系统中，想找相似图片
- 图片已经预先处理过特征向量
- 需要快速查询（无需重新计算特征）

**优势：** 速度快，直接使用数据库中已有的特征向量

**前提条件：** 图片ID对应的特征向量必须已存在于 `tb_hsx_img_value` 表中

### 场景2：通过图片URL查找相似图片

适用于：
- 图片未在系统中，但有可访问的URL
- 临时搜索，不需要保存特征向量
- 外部图片相似度检测

**优势：** 灵活，不需要提前导入图片

**注意事项：** 
- 需要从URL下载图片，速度相对较慢
- URL必须可访问
- 每次都会重新计算特征向量

## 前端使用

访问前端页面：`http://localhost:3000/image-search`

### 功能介绍

前端提供三种搜索模式：

1. **📤 上传图片**
   - 支持拖拽上传
   - 点击上传
   - 实时预览

2. **🔢 图片ID**
   - 输入图片ID
   - 快速搜索
   - 需要图片已有特征向量

3. **🔗 图片URL**
   - 输入图片URL
   - 系统自动加载并计算
   - 支持外部图片

### 相似度阈值调整

- 可通过滑块调整相似度阈值（50% - 99%）
- 默认值：80%
- 阈值越高，结果越精确但数量越少

### 搜索结果展示

- 网格布局展示相似图片
- 显示相似度百分比
- 显示图片ID和MD5
- 支持hover效果查看详情

## 测试

### 运行测试脚本

```bash
cd service

# 确保后端服务已启动
npm run dev

# 在另一个终端运行测试
npm run test-search-api
```

### 测试内容

测试脚本会自动执行以下测试：

1. ✅ 参数验证测试
2. ✅ 通过图片ID搜索测试
3. ✅ 通过图片URL搜索测试

### 测试输出示例

```
============================================================
🚀 开始测试图片相似搜索接口（通过ID或URL）
============================================================

🧪 测试：参数验证（不提供任何参数）
✅ 参数验证正常！错误信息：请提供 imageId 或 imageUrl 参数

🧪 测试：通过图片ID搜索相似图片 (ID: 1730869206754000000)
✅ 成功！找到 3 张相似图片
   示例结果：
   - ID: 1730869206754000001, 相似度: 95.67%, URL: ...
   - ID: 1730869206754000002, 相似度: 88.42%, URL: ...

🧪 测试：通过图片URL搜索相似图片
   URL: https://assets.ecaisys.com/similarity/test.jpg
✅ 成功！找到 2 张相似图片
   示例结果：
   - ID: 1730869206754000003, 相似度: 92.15%, URL: ...

============================================================
📊 测试结果摘要
============================================================
1. ✅ 参数验证: 参数验证正常工作
2. ✅ 通过图片ID搜索: 找到 3 张相似图片（相似度 >= 80%）
3. ✅ 通过图片URL搜索: 找到 2 张相似图片（相似度 >= 80%）

------------------------------------------------------------
总计: 3/3 个测试通过 (100%)
============================================================

🎉 所有测试通过！
```

## 性能说明

### 通过图片ID搜索
- **速度：** 快（约1-3秒）
- **原理：** 直接读取数据库中的特征向量
- **网络开销：** 无

### 通过图片URL搜索
- **速度：** 中等（约3-10秒）
- **原理：** 下载图片 → 计算特征向量 → 搜索
- **网络开销：** 需要下载完整图片

### 优化建议

1. 对于高频查询的图片，建议先导入系统并计算特征向量
2. 使用CDN或本地存储加速图片加载
3. 适当调整相似度阈值减少结果数量

## 常见问题

### Q1: 提示"图片ID的特征向量不存在"

**原因：** 该图片尚未处理过特征向量

**解决方法：**
```bash
# 方法1：处理单张图片
curl -X POST http://127.0.0.1:7001/api/image-feature/process \
  -H "Content-Type: application/json" \
  -d '{"imageId": "1730869206754000000"}'

# 方法2：批量处理所有图片
npm run batch-process
```

### Q2: 通过URL搜索时提示"无法加载图片"

**可能原因：**
- URL不可访问
- 图片格式不支持
- 网络连接问题

**解决方法：**
- 检查URL是否正确
- 确保图片为 JPG/PNG/GIF 格式
- 检查网络连接

### Q3: 搜索结果为空

**可能原因：**
- 相似度阈值设置过高
- 数据库中图片较少
- 图片差异较大

**解决方法：**
- 降低相似度阈值（如从0.9降到0.7）
- 增加数据库中的图片数量
- 尝试其他图片

## 相关链接

- [主 README](./README.md)
- [数据库配置](./DATABASE-CONFIG.md)
- [快速开始](./QUICK-START-DB-CONFIG.md)
- [Docker 部署](./DOCKER-DEPLOYMENT.md)

